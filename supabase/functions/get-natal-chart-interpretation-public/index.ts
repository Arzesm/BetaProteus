import { serve } from "https://deno.land/std@0.190.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY");
// Optional: Assistant ID for future use with Assistants API
const OPENAI_ASSISTANT_ID = Deno.env.get("OPENAI_ASSISTANT_ID");

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  // –ü—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  console.log('üîì –ü—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è get-natal-chart-interpretation –≤—ã–∑–≤–∞–Ω–∞');

  if (!OPENAI_API_KEY) {
    return new Response(JSON.stringify({ error: '–ö–ª—é—á OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.' }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }

  try {
    const { name, gender, planets, ascendant, aspects, nodes, configurations } = await req.json();
    if (!planets || !ascendant || !aspects || !name || !gender) {
      return new Response(JSON.stringify({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è, –ø–æ–ª, –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç, –∞—Å—Ü–µ–Ω–¥–µ–Ω—Ç –∏ –∞—Å–ø–µ–∫—Ç—ã.' }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      })
    }

    const chartDescription = `
–ò–º—è: ${name}.
–ü–æ–ª: ${gender === 'male' ? '–ú—É–∂—Å–∫–æ–π' : gender === 'female' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–î—Ä—É–≥–æ–π'}.
–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: ${ascendant.sign}.
–ü–ª–∞–Ω–µ—Ç—ã:
${planets.map((p: { name: string; sign: string; house: number; rulesHouses: number[] }) => {
    let rulership = '';
    if (p.rulesHouses && p.rulesHouses.length > 0) {
        rulership = `, —É–ø—Ä–∞–≤–ª—è–µ—Ç ${p.rulesHouses.join(' –∏ ')} –¥–æ–º–æ–º(–∞–º–∏)`;
    }
    return `${p.name} –≤ –∑–Ω–∞–∫–µ ${p.sign} –≤ ${p.house} –¥–æ–º–µ${rulership}`;
}).join('.\n')}.
–õ—É–Ω–Ω—ã–µ —É–∑–ª—ã:
${nodes ? `–°–µ–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª –≤ ${nodes.north.sign}, ${nodes.north.house} –¥–æ–º.
–Æ–∂–Ω—ã–π —É–∑–µ–ª –≤ ${nodes.south.sign}, ${nodes.south.house} –¥–æ–º.` : '–ù/–î'}
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
${configurations && configurations.length > 0 ? configurations.map((c: { name: string; participants: string[] }) => `${c.name}: ${c.participants.join(', ')}`).join('.\n') : '–ù–µ—Ç —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.'}
–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
${aspects.map((a: { planet1: string; planet2: string; aspectName: string; orb: number }) => `${a.planet1} ${a.aspectName} ${a.planet2} (–æ—Ä–±–∏—Å ${a.orb.toFixed(1)}¬∞)`).join('.\n')}.
`;

    const systemPrompt = `üéØ –†–æ–ª—å

–í—ã ‚Äî –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ¬´Proteus¬ª, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ú–∞–∫—Å–∏–º–æ–º –ó–∞–π—Ü–µ–≤—ã–º. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫—É –≥–ª—É–±–æ–∫—É—é, –ø—Ä–∏–∫–ª–∞–¥–Ω—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º.

–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —á–µ–ª–æ–≤–µ–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ ¬´–í—ã¬ª.

üîé –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)

–°–Ω–∞—á–∞–ª–∞ ‚Äî File Search.

–ò—â–∏—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –≤–æ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

–í—Å—ë, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–æ–≤, –±–µ—Ä–∏—Ç–µ –∏–∑ —Ñ–∞–π–ª–æ–≤.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π—Ç–µ —Ñ–∞–∫—Ç—ã –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ, –æ—Ç–∫—É–¥–∞ —á—Ç–æ –≤–∑—è–ª–∏ (–ø–µ—Ä–µ—Å–∫–∞–∑ —Å–º—ã—Å–ª–∞).

–°–∏–Ω—Ç–µ–∑, –∞ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∑.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫–∞–∫ –±–∞–∑—É, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ –∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –∫ –∂–∏–∑–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞.

–û–±—ä—ë–º –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç—å.

–ú–∏–Ω–∏–º—É–º 2000 —Å–ª–æ–≤ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ 2000‚Äì3000). –ï—Å–ª–∏ –º–µ–Ω—å—à–µ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

–ü–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º ‚Äî —á–µ–∫:

File Search –≤—ã–ø–æ–ª–Ω–µ–Ω

–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º

–ù–µ—Ç —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –∂–∞—Ä–≥–æ–Ω–∞

–û–±—ä—ë–º ‚â• 1500 —Å–ª–æ–≤

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±–ª—é–¥–µ–Ω–∞

üö´ –ó–∞–ø—Ä–µ—Ç—ã –∏ —Å—Ç–∏–ª—å —è–∑—ã–∫–∞

–ó–∞–ø—Ä–µ—â–µ–Ω—ã –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∂–∞—Ä–≥–æ–Ω: –Ω–∞–∑–≤–∞–Ω–∏—è –∑–Ω–∞–∫–æ–≤, –¥–æ–º–æ–≤, –ø–ª–∞–Ω–µ—Ç, –∞—Å–ø–µ–∫—Ç–æ–≤, –≥—Ä–∞–¥—É—Å—ã, —É–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –∏ —Ç.–ø.

–ó–∞–º–µ–Ω—è–π—Ç–µ –∏—Ö –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö –∫–∞—á–µ—Å—Ç–≤, –º–æ—Ç–∏–≤–æ–≤, —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å—é–∂–µ—Ç–æ–≤.

–ü–∏—à–∏—Ç–µ –∂–∏–≤—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º, —Ç—ë–ø–ª—ã–º –∏ —è—Å–Ω—ã–º —è–∑—ã–∫–æ–º ‚Äî –∫–∞–∫ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –ì–æ–≤–æ—Ä–∏—Ç–µ –ø—Ä–æ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, –ø—Ä–∏–≤—ã—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∑–æ–Ω—ã —Ä–æ—Å—Ç–∞, –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞.

–ù–µ —É–ø–æ–º–∏–Ω–∞–π—Ç–µ –∏–º–µ–Ω–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–æ–≤/—à–∫–æ–ª. –ù–µ —Å—Å—ã–ª–∞–π—Ç–µ—Å—å –Ω–∞ ¬´–∑–Ω–∞–∫–∏¬ª –∏ —Ç.–¥.

üß± –§–æ—Ä–º–∞—Ç –∏ –≤–∏–∑—É–∞–ª

–ñ–∏—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã, —Ü–∏—Ç–∞—Ç—ã, —ç–º–æ–¥–∑–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (üåø‚ú®üí´) ‚Äî —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –ª–µ–≥–∫–æ.

–î–æ–±–∞–≤–ª—è–π—Ç–µ –º–∏–Ω–∏-–∫–µ–π—Å—ã (–∂–∏–∑–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã): ¬´–ï—Å–ª–∏ —É –í–∞—Å —Ç–∞–∫-—Ç–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Ç —ç—Ç–æ‚Ä¶¬ª.

üóÇÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã. –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–∞—Ö –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–¥–µ–ª—É, –Ω–∞–ø–∏—à–∏—Ç–µ —ç—Ç–æ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π.

0) –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ

2‚Äì4 –∞–±–∑–∞—Ü–∞: —Ü–µ–ª—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –∫–∞–∫ —á–∏—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å.

–ö–æ—Ä–æ—Ç–∫–æ: ¬´–ß—Ç–æ –≤ –í–∞—Å –∑–∞–º–µ—Ç–Ω–æ —Å—Ä–∞–∑—É¬ª ‚Äî 3‚Äì5 –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ.

1) –õ–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –º–æ—Ç–∏–≤–∞—Ü–∏—è

–ë–∞–∑–æ–≤—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã, —Ü–µ–Ω–Ω–æ—Å—Ç–∏, —Å—Ç–∏–ª—å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π.

–ö–∞–∫ –í—ã –ø—Ä–æ—è–≤–ª—è–µ—Ç–µ—Å—å –≤ —Å–ø–æ–∫–æ–π–Ω—ã—Ö –∏ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.

–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ ¬´—Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã¬ª (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏).

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –∫–∞–∫ —É—Å–∏–ª–∏—Ç—å —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã; –∫–∞–∫ –º—è–≥–∫–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–ª–∞–±—ã–µ.

2) –¢–∞–ª–∞–Ω—Ç—ã, –Ω–∞–≤—ã–∫–∏, –º—ã—à–ª–µ–Ω–∏–µ

–¢–∏–ø –º—ã—à–ª–µ–Ω–∏—è (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞/—Å–∏–Ω—Ç–µ–∑/–≤–∏–∑—É–∞–ª/–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è), —Å—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è.

–ì–¥–µ –í—ã –±—ã—Å—Ç—Ä–µ–µ –¥—Ä—É–≥–∏—Ö —Ä–∞—Å—Ç—ë—Ç–µ; –∫–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ä–∞–±–æ—Ç—ã ¬´—Å–∞–¥—è—Ç—Å—è¬ª (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ/–∫–æ–º–∞–Ω–¥–∞/–ø—É–±–ª–∏—á–Ω–æ).

–ü—Ä–∞–∫—Ç–∏–∫–∞ 2‚Äì4 –Ω–µ–¥–µ–ª–∏: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞–≤—ã–∫–æ–≤.

3) –î–µ–Ω—å–≥–∏, –∫–∞—Ä—å–µ—Ä–∞, —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏.

–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ñ–µ—Ä—ã/–Ω–∏—à–∏/—Ä–æ–ª–∏ (3‚Äì7 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å –∫—Ä–∞—Ç–∫–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º ¬´–ø–æ—á–µ–º—É¬ª).

–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–æ—Å—Ç–∞: —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 90 –¥–Ω–µ–π.

–¢–∞–±–ª–∏—Ü–∞: ¬´–°—Ñ–µ—Ä–∞ ‚Äî –°–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ‚Äî –†–∏—Å–∫ ‚Äî –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥¬ª.

4) –û—Ç–Ω–æ—à–µ–Ω–∏—è, –ª—é–±–æ–≤—å, —Å–µ–º—å—è, —Å–µ–∫—Å—É–∞–ª—å–Ω–æ—Å—Ç—å

–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –±–ª–∏–∑–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

–ö–∞–∫ –í—ã –ª—é–±–∏—Ç–µ, –∫–∞–∫ –¥–∞—ë—Ç–µ/–ø—Ä–æ—Å–∏—Ç–µ –∑–∞–±–æ—Ç—É, –≥–¥–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

–°–µ–∫—Å—É–∞–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞: —á—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, —á—Ç–æ –≥–∞—Å–∏—Ç –∏–Ω—Ç–µ—Ä–µ—Å, —ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: 5 –ø—Ä–∞–≤–∏–ª –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –¥–ª—è –í–∞—Å.

5) –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏

–ö–∞–∫ –í–∞—Å –≤–∏–¥—è—Ç —Ä–∞–∑–Ω—ã–µ –≥—Ä—É–ø–ø—ã (–¥—Ä—É–∑—å—è/–∫–æ–ª–ª–µ–≥–∏/–ø–∞—Ä—Ç–Ω—ë—Ä—ã/–ø—É–±–ª–∏–∫–∞).

–ù–∞–≤—ã–∫–∏ –≤–ª–∏—è–Ω–∏—è –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤; –≥–¥–µ —Å—Ç–æ–∏—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –º—è–≥—á–µ/–∂—ë—Å—Ç—á–µ.

–®–∞–±–ª–æ–Ω—ã —Ñ—Ä–∞–∑ ¬´–¥–ª—è –í–∞—Å¬ª –≤ —Å–ª–æ–∂–Ω—ã—Ö –±–µ—Å–µ–¥–∞—Ö.

6) –ò–Ω—Ç—É–∏—Ü–∏—è, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, —Å–Ω—ã

–ö–∞–Ω–∞–ª—ã —Ç–æ–Ω–∫–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è (—á–µ—Ä–µ–∑ —Ç–µ–ª–æ, –æ–±—Ä–∞–∑—ã, –º—É–∑—ã–∫—É, —Ç–µ–∫—Å—Ç—ã, —Å–Ω–æ–≤–∏–¥–µ–Ω–∏—è).

–¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ ¬´–∑–∞–∑–µ–º–ª—è—é—Ç¬ª –∏ –¥–∞—é—Ç —ç–Ω–µ—Ä–≥–∏—é.

–ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–±–æ—Ç—ã —Å–æ —Å–Ω–∞–º–∏/–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º –Ω–∞ 14 –¥–Ω–µ–π.

7) –ó–¥–æ—Ä–æ–≤—å–µ, —Ä–µ–∂–∏–º, —ç–Ω–µ—Ä–≥–∏—è (–Ω–µ –º–µ–¥–∏—Ü–∏–Ω–∞)

–¢–∏–ø —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: —á—Ç–æ –í–∞—Å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ–≥–æ.

–†–µ–∂–∏–º –¥–Ω—è/—Å–Ω–∞, –ø–∏—Ç–∞–Ω–∏–µ/–Ω–∞–≥—Ä—É–∑–∫–∏ –≤ –æ–±—â–∏—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞—Ö (–±–µ–∑ –º–µ–¥.—Å–æ–≤–µ—Ç–æ–≤).

–≠–Ω–µ—Ä–≥–æ–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç: –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏, –∫–æ–≥–¥–∞ ‚Äî –∫—Ä–µ–∞—Ç–∏–≤.

8) –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º

–î–µ–Ω—å–≥–∏, –≤–µ—â–∏, –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ: –∫–∞–∫ –Ω–∞ —ç—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ –∏ –≥–¥–µ —Ç–µ—Ä—è–µ—Ç–µ —Ä–µ—Å—É—Ä—Å.

–ú–µ—Ç–æ–¥—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤.

–ß–µ–∫-–ª–∏—Å—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ (30‚Äì60 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å).

9) –†–∏—Å–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏

–í–∞—à–∏ —Ç–∏–ø–∏—á–Ω—ã–µ ¬´–ª–æ–≤—É—à–∫–∏¬ª: –Ω–∞ —á—Ç–æ –í—ã ¬´–≤–µ–¥—ë—Ç–µ—Å—å¬ª, —á—Ç–æ –∑–∞–±–∏—Ä–∞–µ—Ç —Å–∏–ª—ã.

–ö–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–∏–∫–∞: 5‚Äì7 —Å–ø–æ—Å–æ–±–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –º–∏–Ω—É—Å—ã –≤ –ø–ª—é—Å—ã.

–°—Ü–µ–Ω–∞—Ä–∏–∏ ¬´–∫–æ–≥–¥–∞ –≤—Å—ë –≤–∞–ª–∏—Ç—Å—è¬ª –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ 72 —á–∞—Å–∞.

10) –û–±—Ä–∞–∑—ã –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã

2‚Äì3 –æ–±—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä—ã–µ ¬´–≤–∫–ª—é—á–∞—é—Ç¬ª –í–∞—Å (–ø–µ—Ä—Å–æ–Ω–∞–∂/–∞—Ä—Ö–µ—Ç–∏–ø/—Å—Ü–µ–Ω–∞).

–ö–æ—Ä–æ—Ç–∫–∏–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏/–º–∞–Ω—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –í–∞—Å.

11) –ò—Ç–æ–≥ –∏ –ø–∞–º—è—Ç–∫–∞

6‚Äì10 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤ ¬´–æ –í–∞—Å¬ª.

–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

üìê –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É

–û–±—ä—ë–º: –º–∏–Ω–∏–º—É–º 2000 —Å–ª–æ–≤ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ 1500‚Äì3000). –ï—Å–ª–∏ –º–µ–Ω—å—à–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≤—ã—à–µ 

–¢–æ–Ω: —Å–ø–æ–∫–æ–π–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π; –æ–±—Ä–∞—â–µ–Ω–∏–µ ‚Äî –Ω–∞ ¬´–í—ã¬ª.

üß™ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç

–ü–∏—à–∏—Ç–µ: ¬´–í –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø–æ —ç—Ç–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç/–º–∞–ª–æ; –Ω–∏–∂–µ ‚Äî –æ–±—â–∏–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏¬ª.

–î–∞–ª—å—à–µ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –º–∏–Ω–∏–º—É–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª–µ–∑–µ–Ω –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ª—é–¥–µ–π, –±–µ–∑ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∂–∞—Ä–≥–æ–Ω.`;

    let interpretation: string | null = null;
    const requestIds: string[] = [];

    let metaUsed = 'chat';
    let metaAssistantSuffix: string | null = null;
    let metaKeyPrefix: string | null = null;
    let metaKeySuffix: string | null = null;

    if (OPENAI_API_KEY) {
      metaKeyPrefix = OPENAI_API_KEY.substring(0, 6);
      metaKeySuffix = OPENAI_API_KEY.substring(OPENAI_API_KEY.length - 6);
    }

    if (OPENAI_ASSISTANT_ID) {
      metaUsed = 'assistants';
      metaAssistantSuffix = OPENAI_ASSISTANT_ID.slice(-6);
      // Assistants API v2 flow
      const threadRes = await fetch('https://api.openai.com/v1/threads', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({}),
      });
      const rid1 = threadRes.headers.get('x-request-id'); if (rid1) { console.log('OpenAI x-request-id thread:', rid1); requestIds.push(rid1); }
      if (!threadRes.ok) throw new Error(`Assistants thread error: ${await threadRes.text()}`);
      const thread = await threadRes.json();

      const msgRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/messages`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({
          role: 'user',
          content: [
            { type: 'text', text: systemPrompt },
            { type: 'text', text: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É:\n\n${chartDescription}` },
          ],
        }),
      });
      const rid2 = msgRes.headers.get('x-request-id'); if (rid2) { console.log('OpenAI x-request-id message:', rid2); requestIds.push(rid2); }
      if (!msgRes.ok) throw new Error(`Assistants message error: ${await msgRes.text()}`);

      const runRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/runs`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({ assistant_id: OPENAI_ASSISTANT_ID }),
      });
      const rid3 = runRes.headers.get('x-request-id'); if (rid3) { console.log('OpenAI x-request-id run:', rid3); requestIds.push(rid3); }
      if (!runRes.ok) throw new Error(`Assistants run error: ${await runRes.text()}`);
      const run = await runRes.json();

      let status = run.status;
      let attempts = 0;
      while (['queued', 'in_progress', 'requires_action'].includes(status) && attempts < 180) {
        attempts++;
        await new Promise(r => setTimeout(r, 1000));
        const poll = await fetch(`https://api.openai.com/v1/threads/${thread.id}/runs/${run.id}`, {
          headers: {
            'Authorization': `Bearer ${OPENAI_API_KEY}`,
            'OpenAI-Beta': 'assistants=v2',
          },
        });
        const data = await poll.json();
        status = data.status;
        if (status === 'requires_action' && data.required_action?.type === 'submit_tool_outputs') {
          console.log('Assistants run requires tool output, but none configured.');
          break;
        }
      }
      if (status !== 'completed') throw new Error(`Assistants run not completed after ${attempts}s: ${status}`);

      const msgsRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/messages?limit=1`, {
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'assistants=v2',
        },
      });
      const rid4 = msgsRes.headers.get('x-request-id'); if (rid4) { console.log('OpenAI x-request-id messages:', rid4); requestIds.push(rid4); }
      const msgs = await msgsRes.json();
      interpretation = msgs.data?.[0]?.content?.[0]?.text?.value || null;
    } else {
      // Fallback to Chat Completions
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É:\n\n${chartDescription}` }
          ],
          max_tokens: 2000,
          temperature: 0.7,
        }),
      });
      const rid = response.headers.get('x-request-id'); if (rid) { console.log('OpenAI x-request-id chat:', rid); requestIds.push(rid); }
      if (!response.ok) throw new Error(`OpenAI API error: ${response.status}`);
      const data = await response.json();
      interpretation = data.choices[0].message.content;
    }

    const meta = { used: metaUsed, assistantIdSuffix: metaAssistantSuffix, apiKeyPrefix: metaKeyPrefix, apiKeySuffix: metaKeySuffix };
    console.log('Interpretation meta', meta);

    return new Response(JSON.stringify({ interpretation, openaiRequestIds: requestIds, meta }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})
