import { serve } from "https://deno.land/std@0.190.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY");
// Optional: Assistant ID for future use with Assistants API
const OPENAI_ASSISTANT_ID = Deno.env.get("OPENAI_ASSISTANT_ID");

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
  const authHeader = req.headers.get('authorization');
  if (!authHeader) {
    console.log('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ');
  }

  if (!OPENAI_API_KEY) {
    return new Response(JSON.stringify({ error: '–ö–ª—é—á OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.' }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }

  try {
    const { name, gender, planets, ascendant, aspects, nodes, configurations } = await req.json();
    if (!planets || !ascendant || !aspects || !name || !gender) {
      return new Response(JSON.stringify({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è, –ø–æ–ª, –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç, –∞—Å—Ü–µ–Ω–¥–µ–Ω—Ç –∏ –∞—Å–ø–µ–∫—Ç—ã.' }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      })
    }

    const chartDescription = `
–ò–º—è: ${name}.
–ü–æ–ª: ${gender === 'male' ? '–ú—É–∂—Å–∫–æ–π' : gender === 'female' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–î—Ä—É–≥–æ–π'}.
–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: ${ascendant.sign}.
–ü–ª–∞–Ω–µ—Ç—ã:
${planets.map((p: { name: string; sign: string; house: number; rulesHouses: number[] }) => {
    let rulership = '';
    if (p.rulesHouses && p.rulesHouses.length > 0) {
        rulership = `, —É–ø—Ä–∞–≤–ª—è–µ—Ç ${p.rulesHouses.join(' –∏ ')} –¥–æ–º–æ–º(–∞–º–∏)`;
    }
    return `${p.name} –≤ –∑–Ω–∞–∫–µ ${p.sign} –≤ ${p.house} –¥–æ–º–µ${rulership}`;
}).join('.\n')}.
–õ—É–Ω–Ω—ã–µ —É–∑–ª—ã:
${nodes ? `–°–µ–≤–µ—Ä–Ω—ã–π —É–∑–µ–ª –≤ ${nodes.north.sign}, ${nodes.north.house} –¥–æ–º.
–Æ–∂–Ω—ã–π —É–∑–µ–ª –≤ ${nodes.south.sign}, ${nodes.south.house} –¥–æ–º.` : '–ù/–î'}
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
${configurations && configurations.length > 0 ? configurations.map((c: { name: string; participants: string[] }) => `${c.name}: ${c.participants.join(', ')}`).join('.\n') : '–ù–µ—Ç —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.'}
–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
${aspects.map((a: { planet1: string; planet2: string; aspectName: string; orb: number }) => `${a.planet1} ${a.aspectName} ${a.planet2} (–æ—Ä–±–∏—Å ${a.orb.toFixed(1)}¬∞)`).join('.\n')}.
`;

    const systemPrompt = `üéØ –†–æ–ª—å –∏ –º–∏—Å—Å–∏—è

–í—ã ‚Äî –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç Proteus, –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ú–∞–∫—Å–∏–º–æ–º –ó–∞–π—Ü–µ–≤—ã–º.
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –ø–æ–Ω—è—Ç–Ω–æ–π, –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –∏ –∂–∏–≤–æ–π —Ñ–æ—Ä–º–µ, –∫–∞–∫ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–í—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ –≥–ª—É–±–∏–Ω–æ–π –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è, –∏–Ω—Ç—É–∏—Ü–∏–µ–π –∏ –ª–æ–≥–∏–∫–æ–π —É—Ä–æ–≤–Ω—è –º–∞—Å—Ç–µ—Ä–∞.
–í—ã –≤–∏–¥–∏—Ç–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–∞–∫—Ç—ã, –∞ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ—Ç–∏–≤–∞—Ü–∏—è–º–∏, –ø–æ—Å—Ç—É–ø–∫–∞–º–∏, –ø—Ä–∏–≤—ã—á–∫–∞–º–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏.
–û–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ ¬´–í—ã¬ª ‚Äî —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, —Å —Ç–∞–∫—Ç–æ–º, –±–µ–∑ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏.

üîé –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)

–ü–µ—Ä–≤–æ–µ ‚Äî File Search.

–°–Ω–∞—á–∞–ª–∞ –∏—â–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –∫–∞–∫ –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å—É—Ç—å –∏ —Å–º—ã—Å–ª –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º.

–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, –∞ –Ω–µ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

–í—ã –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤, –∞ –æ–±—ä—è—Å–Ω—è–µ—Ç–µ —Å–º—ã—Å–ª –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞.

–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–∏—á–Ω–æ—Å—Ç–∏, –ø–æ—Å—Ç—É–ø–∫–∞—Ö, —Ä–µ—à–µ–Ω–∏—è—Ö –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏.

–û–±—ä—ë–º –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç—å.

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3000 —Å–ª–æ–≤ (‚âà 18 000‚Äì22 000 —Å–∏–º–≤–æ–ª–æ–≤).

–ï—Å–ª–∏ –æ–±—ä—ë–º –º–µ–Ω—å—à–µ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ, –ø–æ–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –Ω–µ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ–π.

–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º, –∫–∞–∫ –≥–æ—Ç–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è.

–ü–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É:

‚úÖ File Search –≤—ã–ø–æ–ª–Ω–µ–Ω.
‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–æ–≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.
‚úÖ –ù–µ—Ç —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∂–∞—Ä–≥–æ–Ω–æ–≤.
‚úÖ –û–±—ä—ë–º ‚â• 3000 —Å–ª–æ–≤.
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–±–ª—é–¥–µ–Ω–∞.

üö´ –ó–∞–ø—Ä–µ—Ç—ã –∏ —Å—Ç–∏–ª—å —è–∑—ã–∫–∞

–ù–∏–∫–∞–∫–∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–≤–∞ –≤—Ä–æ–¥–µ: ¬´–∑–Ω–∞–∫¬ª, ¬´–¥–æ–º¬ª, ¬´–ø–ª–∞–Ω–µ—Ç–∞¬ª, ¬´–∞—Å–ø–µ–∫—Ç¬ª, ¬´—É–ø—Ä–∞–≤–∏—Ç–µ–ª—å¬ª, ¬´–≥—Ä–∞–¥—É—Å¬ª –∏ —Ç.–ø.
–ó–∞–º–µ–Ω—è–π—Ç–µ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∫–∞—á–µ—Å—Ç–≤, —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –º–æ—Ç–∏–≤–æ–≤ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–≤–µ–¥–µ–Ω–∏—è.

–ù–∏–∫–∞–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞ –∏–ª–∏ —Ü–∏—Ç–∞—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–æ–≤.
–í—Å–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–≤—É—á–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –≤ –∂–∏–≤–æ–π –±–µ—Å–µ–¥–µ.

–ù–∏–∫–∞–∫–∏—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π.
–í—ã –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç–µ –±—É–¥—É—â–µ–µ, –∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, —Å—Ü–µ–Ω–∞—Ä–∏–∏, —Å–æ—Å—Ç–æ—è–Ω–∏—è, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∏ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞.

–Ø–∑—ã–∫: –∂–∏–≤–æ–π, –æ–±—Ä–∞–∑–Ω—ã–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã, –ø—Ä–∏–º–µ—Ä—ã, –∞–Ω–∞–ª–æ–≥–∏–∏, –º–∏–Ω–∏-–∫–µ–π—Å—ã.
–¢–æ–Ω ‚Äî —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π.

üß± –§–æ—Ä–º–∞—Ç –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
–ñ–∏—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
–°–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã, —Ü–∏—Ç–∞—Ç—ã, –ª—ë–≥–∫–∏–µ —ç–º–æ–¥–∑–∏ üåø‚ú®üí´.
–í—Å—Ç–∞–≤–ª—è–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–º–µ—Ä—ã:
¬´–ï—Å–ª–∏ –í—ã –∑–∞–º–µ—á–∞–µ—Ç–µ, —á—Ç–æ —á–∞—Å—Ç–æ –±–µ—Ä—ë—Ç–µ –Ω–∞ —Å–µ–±—è –ª–∏—à–Ω–µ–µ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–¥–∞—á—É –≤ –¥–µ–Ω—å.¬ª

üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ Proteus (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã)

–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –±–ª–æ–∫ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏, –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏.
–ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–¥–µ–ª—É, –Ω–∞–ø–∏—à–∏—Ç–µ:
¬´–í –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø–æ —ç—Ç–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–∏–∂–µ ‚Äî –æ–±—â–∏–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ª—é–¥–µ–π.¬ª

üîπ 0. –ë–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É —Å —Å—É—Ç–∏. –ù–µ –ø–∏—à–∏—Ç–µ ‚Äú—è –≤–∏–∂—É –≤ –í–∞—à–µ–π –∫–∞—Ä—Ç–µ‚Äù –∏–ª–∏ ‚Äú–≤ –í–∞—à–µ–º –≥–æ—Ä–æ—Å–∫–æ–ø–µ‚Äù. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å—Ä–∞–∑—É —Å —Ñ–∞–∫—Ç–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –µ—ë –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π.

üîπ 1. –õ–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –º–æ—Ç–∏–≤–∞—Ü–∏—è
–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≥–ª—É–±–∏–Ω–Ω—ã—Ö –¥—Ä–∞–π–≤–µ—Ä–∞—Ö: —á—Ç–æ –¥–≤–∏–∂–µ—Ç —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–∞–∫–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —É –Ω–µ–≥–æ –≤ –æ—Å–Ω–æ–≤–µ.
–û–ø–∏—à–∏—Ç–µ –µ–≥–æ —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è, —Å–ø–æ—Å–æ–± –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —É—Å–ø–µ—Ö –∏ —Å—Ç—Ä–µ—Å—Å.
–î–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π.
–î–æ–±–∞–≤—å—Ç–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç.

üîπ 2. –¢–∞–ª–∞–Ω—Ç—ã, –Ω–∞–≤—ã–∫–∏, –º—ã—à–ª–µ–Ω–∏–µ
–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ–≥–æ —É–º: –ª–æ–≥–∏—á–µ—Å–∫–∏, –æ–±—Ä–∞–∑–Ω–æ, –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∏–Ω—Ç–µ–∑.
–ü–æ–∫–∞–∂–∏—Ç–µ, –≤ —á—ë–º —á–µ–ª–æ–≤–µ–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤ ‚Äî –∫ –æ–±—â–µ–Ω–∏—é, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –∫—Ä–µ–∞—Ç–∏–≤—É, –æ–±—É—á–µ–Ω–∏—é.
–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ 2‚Äì4 –Ω–µ–¥–µ–ª–∏: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —É–∫—Ä–µ–ø–∏—Ç—å –Ω–∞–≤—ã–∫–∏.

üîπ 3. –î–µ–Ω—å–≥–∏, –∫–∞—Ä—å–µ—Ä–∞, —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–†–∞—Å–∫—Ä–æ–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ –¥–µ–Ω—å–≥–∞—Ö, –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –∫ —Ä–∏—Å–∫—É, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å–≤–æ–±–æ–¥–µ.
–û–ø–∏—à–∏—Ç–µ, –≥–¥–µ —É —á–µ–ª–æ–≤–µ–∫–∞ —Å–∏–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤ —Ä–∞–±–æ—Ç–µ.
–î–æ–±–∞–≤—å—Ç–µ 3‚Äì7 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç (—Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º ¬´–ø–æ—á–µ–º—É¬ª).
–í –∫–æ–Ω—Ü–µ ‚Äî —Ç–∞–±–ª–∏—Ü–∞: ¬´–°—Ñ–µ—Ä–∞ ‚Äî –°–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ‚Äî –†–∏—Å–∫ ‚Äî –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥¬ª.

üîπ 4. –û—Ç–Ω–æ—à–µ–Ω–∏—è, –ª—é–±–æ–≤—å, —Å–µ–º—å—è, —Å–µ–∫—Å—É–∞–ª—å–Ω–æ—Å—Ç—å
–û–ø–∏—à–∏—Ç–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞; —Å–ø–æ—Å–æ–± –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –±–ª–∏–∑–æ—Å—Ç–∏, –æ–∂–∏–¥–∞–Ω–∏—è –∏ —Å—Ç—Ä–∞—Ö–∏.
–ü–∏—à–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º, –≤–∫–ª—é—á–∞—è —Å–µ–∫—Å—É–∞–ª—å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É.
–î–æ–±–∞–≤—å—Ç–µ 5 –ø—Ä–∞–≤–∏–ª –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.

üîπ 5. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏
–ö–∞–∫ —á–µ–ª–æ–≤–µ–∫–∞ –≤–∏–¥—è—Ç –¥—Ä—É–∑—å—è, –∫–æ–ª–ª–µ–≥–∏, –ø–∞—Ä—Ç–Ω—ë—Ä—ã –∏ –ø—É–±–ª–∏–∫–∞.
–ì–¥–µ –æ–Ω –Ω–∞–∏–±–æ–ª–µ–µ —É–±–µ–¥–∏—Ç–µ–ª–µ–Ω –∏ –≥–¥–µ —Å—Ç–æ–∏—Ç –±—ã—Ç—å –º—è–≥—á–µ.
–î–∞–π—Ç–µ 3‚Äì5 —Ñ—Ä–∞–∑‚Äë—à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.

üîπ 6. –ò–Ω—Ç—É–∏—Ü–∏—è, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, —Å–Ω—ã
–ö–∞–Ω–∞–ª—ã —Ç–æ–Ω–∫–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è; —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –¥–∞—é—â–∏–µ —ç–Ω–µ—Ä–≥–∏—é.
–ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–±–æ—Ç—ã —Å–æ —Å–Ω–∞–º–∏/–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º –Ω–∞ 14 –¥–Ω–µ–π.

üîπ 7. –≠–Ω–µ—Ä–≥–∏—è, –∑–¥–æ—Ä–æ–≤—å–µ, —Ä–∏—Ç–º –∂–∏–∑–Ω–∏ (–Ω–µ –º–µ–¥–∏—Ü–∏–Ω–∞)
–°—Ç–∏–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, —Ä–µ–∂–∏–º –¥–Ω—è/—Å–Ω–∞, –±–∞–ª–∞–Ω—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
–ü—Ä–æ—Å—Ç—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç–Ω–µ—Ä–≥–æ–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É.

üîπ 8. –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º
–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥–µ–Ω—å–≥–∞–º/–≤–µ—â–∞–º/–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É; –º–µ—Ç–æ–¥—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
–ß–µ–∫‚Äë–ª–∏—Å—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ (30‚Äì60 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å).

üîπ 9. –†–∏—Å–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
–¢–∏–ø–∏—á–Ω—ã–µ ¬´–ª–æ–≤—É—à–∫–∏¬ª –∏ –∑–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
5‚Äì7 —Å–ø–æ—Å–æ–±–æ–≤ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –º–∏–Ω—É—Å—ã –≤ –ø–ª—é—Å—ã.
–ü—Ä–æ—Ç–æ–∫–æ–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ 72 —á–∞—Å–∞.

üîπ 10. –û–±—Ä–∞–∑—ã –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã
2‚Äì3 –∞—Ä—Ö–µ—Ç–∏–ø–∞/—Å—Ü–µ–Ω—ã/—Å–∏–º–≤–æ–ª–∞; –∫–æ—Ä–æ—Ç–∫–∏–µ –º–∞–Ω—Ç—Ä—ã –ø–æ–¥ —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏.

üîπ 11. –ò—Ç–æ–≥ –∏ –ø–∞–º—è—Ç–∫–∞
6‚Äì10 —Ç–µ–∑–∏—Å–æ–≤ ¬´–æ –í–∞—Å¬ª –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è.

üß© –¢–æ–Ω –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
–í—Å–µ–≥–¥–∞ –Ω–∞ ¬´–í—ã¬ª. –ì–æ–≤–æ—Ä–∏—Ç–µ –∫–∞–∫ –∂–∏–≤–æ–π —ç–∫—Å–ø–µ—Ä—Ç, –∏–∑–±–µ–≥–∞–π—Ç–µ –≤–æ–¥—ã –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤.
–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –º—ã—Å–ª—å.

üìê –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
–û–±—ä—ë–º ‚Äî –º–∏–Ω–∏–º—É–º 3000 —Å–ª–æ–≤. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Äî File Search. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã (1‚Äì11). –¢–æ–Ω ‚Äî —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, —Ç—ë–ø–ª—ã–π, –∂–∏–≤–æ–π. –§–æ—Ä–º–∞—Ç ‚Äî Markdown.

‚ö° –í —Å–ª—É—á–∞–µ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
¬´–í –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É. –ù–∏–∂–µ ‚Äî –æ–±—â–∏–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ª—é–¥–µ–π.¬ª –ó–∞—Ç–µ–º ‚Äî –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –æ–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è.

üöÄ –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç Proteus –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–º, –∂–∏–≤—ã–º –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º –º–∏–Ω–∏–º—É–º 3000 —Å–ª–æ–≤–∞–º–∏, –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å—Ä–∞–∑—É —Å —Å—É—Ç–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –∑–≤—É—á–∞—Ç—å –∫–∞–∫ —Ä–µ—á—å –æ–ø—ã—Ç–Ω–æ–≥–æ –∞—Å—Ç—Ä–æ–ª–æ–≥–∞‚Äë–ø—Å–∏—Ö–æ–ª–æ–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç —Å —á–µ–ª–æ–≤–µ–∫–æ–º, –∞ –Ω–µ –æ —á–µ–ª–æ–≤–µ–∫–µ.`;
    
    const userPrompt = `–°–¥–µ–ª–∞–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:\n${chartDescription}`;

    let interpretation: string | null = null;
    const requestIds: string[] = [];

    let metaUsed = 'chat';
    let metaAssistantSuffix: string | null = null;
    let metaKeyPrefix: string | null = null;
    let metaKeySuffix: string | null = null;

    if (OPENAI_API_KEY) {
      metaKeyPrefix = OPENAI_API_KEY.substring(0, 6);
      metaKeySuffix = OPENAI_API_KEY.substring(OPENAI_API_KEY.length - 6);
    }

    if (OPENAI_ASSISTANT_ID) {
      metaUsed = 'assistants';
      metaAssistantSuffix = OPENAI_ASSISTANT_ID.slice(-6);
      // Use Assistants API v2 when assistant id provided
      const threadRes = await fetch('https://api.openai.com/v1/threads', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({}),
      });
      const rid1 = threadRes.headers.get('x-request-id'); if (rid1) { console.log('OpenAI x-request-id thread:', rid1); requestIds.push(rid1); }
      if (!threadRes.ok) {
        const tErr = await threadRes.text();
        throw new Error(`Assistants thread error: ${tErr}`);
      }
      const thread = await threadRes.json();

      // Add user message
      const msgRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/messages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({
          role: 'user',
          content: [
            { type: 'text', text: systemPrompt },
            { type: 'text', text: userPrompt },
          ],
        }),
      });
      const rid2 = msgRes.headers.get('x-request-id'); if (rid2) { console.log('OpenAI x-request-id message:', rid2); requestIds.push(rid2); }
      if (!msgRes.ok) throw new Error(`Assistants message error: ${await msgRes.text()}`);

      const runRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/runs`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'assistants=v2',
        },
        body: JSON.stringify({ assistant_id: OPENAI_ASSISTANT_ID }),
      });
      if (!runRes.ok) throw new Error(`Assistants run error: ${await runRes.text()}`);
      const rid3 = runRes.headers.get('x-request-id'); if (rid3) { console.log('OpenAI x-request-id run:', rid3); requestIds.push(rid3); }
      const run = await runRes.json();

      // Poll until completed
      let status = run.status;
      const runId = run.id;
      let attempts = 0;
      while (['queued', 'in_progress', 'requires_action'].includes(status) && attempts < 180) {
        attempts++;
        await new Promise(r => setTimeout(r, 1000));
        const poll = await fetch(`https://api.openai.com/v1/threads/${thread.id}/runs/${runId}`, {
          headers: {
            'Authorization': `Bearer ${OPENAI_API_KEY}`,
            'OpenAI-Beta': 'assistants=v2',
          },
        });
        const pollData = await poll.json();
        status = pollData.status;
        if (status === 'requires_action' && pollData.required_action?.type === 'submit_tool_outputs') {
          console.log('Assistants run requires tool outputs but none configured.');
          break;
        }
      }

      if (status !== 'completed') {
        throw new Error(`Assistants run not completed after ${attempts}s: ${status}`);
      }

      const msgsRes = await fetch(`https://api.openai.com/v1/threads/${thread.id}/messages?limit=1`, {
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'assistants=v2',
        },
      });
      const rid4 = msgsRes.headers.get('x-request-id'); if (rid4) { console.log('OpenAI x-request-id messages:', rid4); requestIds.push(rid4); }
      const msgs = await msgsRes.json();
      const parts = msgs.data?.[0]?.content?.[0];
      interpretation = parts?.text?.value || null;
    } else {
      // Fallback to Chat Completions
      const requestBody = {
        model: "gpt-4o",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt },
        ],
      };

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
        },
        body: JSON.stringify(requestBody),
      });
      const rid = response.headers.get('x-request-id'); if (rid) { console.log('OpenAI x-request-id chat:', rid); requestIds.push(rid); }
      const data = await response.json();
      if (!response.ok || !data.choices || data.choices.length === 0) {
        console.error('OpenAI API Error:', data);
        const errorMessage = data.error?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI.';
        return new Response(JSON.stringify({ error: errorMessage }), {
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
          status: response.status,
        });
      }
      interpretation = data.choices[0].message.content;
    }

    // include request ids for observability
    console.log('OpenAI request ids:', requestIds);
    const meta = { used: metaUsed, assistantIdSuffix: metaAssistantSuffix, apiKeyPrefix: metaKeyPrefix, apiKeySuffix: metaKeySuffix };
    console.log('Interpretation meta', meta);

    return new Response(JSON.stringify({ interpretation, openaiRequestIds: requestIds, meta }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })
    return new Response(JSON.stringify({ interpretation }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})