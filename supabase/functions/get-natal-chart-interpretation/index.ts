import { serve } from "https://deno.land/std@0.190.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const OPENAI_API_KEY = "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";

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  if (!OPENAI_API_KEY) {
    return new Response(JSON.stringify({ error: '–ö–ª—é—á OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.' }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }

  try {
    const { name, gender, planets, ascendant, aspects } = await req.json();
    if (!planets || !ascendant || !aspects || !name || !gender) {
      return new Response(JSON.stringify({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è, –ø–æ–ª, –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç, –∞—Å—Ü–µ–Ω–¥–µ–Ω—Ç –∏ –∞—Å–ø–µ–∫—Ç—ã.' }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      })
    }

    const chartDescription = `
–ò–º—è: ${name}.
–ü–æ–ª: ${gender === 'male' ? '–ú—É–∂—Å–∫–æ–π' : gender === 'female' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–î—Ä—É–≥–æ–π'}.
–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: ${ascendant.sign}.
–ü–ª–∞–Ω–µ—Ç—ã:
${planets.map((p: { name: string; sign: string; house: number; rulesHouses: number[] }) => {
    let rulership = '';
    if (p.rulesHouses && p.rulesHouses.length > 0) {
        rulership = `, —É–ø—Ä–∞–≤–ª—è–µ—Ç ${p.rulesHouses.join(' –∏ ')} –¥–æ–º–æ–º(–∞–º–∏)`;
    }
    return `${p.name} –≤ –∑–Ω–∞–∫–µ ${p.sign} –≤ ${p.house} –¥–æ–º–µ${rulership}`;
}).join('.\n')}.
–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
${aspects.map((a: { planet1: string; planet2: string; aspectName: string; orb: number }) => `${a.planet1} ${a.aspectName} ${a.planet2} (–æ—Ä–±–∏—Å ${a.orb.toFixed(1)}¬∞)`).join('.\n')}.
`;

    const systemPrompt = `–†–æ–ª—å:
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–ª–æ–∂–Ω—ã–π —è–∑—ã–∫ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –≤ –ø–æ–Ω—è—Ç–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –≥–ª—É–±–æ–∫—É—é, —á–µ—Å—Ç–Ω—É—é –∏ –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ –∫–∞–Ω–æ–Ω–∞—Ö –∑–∞–ø–∞–¥–Ω–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
1.  **–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–π—Å—è –∫ —á–µ–ª–æ–≤–µ–∫—É –Ω–∞–ø—Ä—è–º—É—é, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–≤—ã¬ª, ¬´–≤–∞—à¬ª, ¬´–≤–∞–º¬ª. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –æ—â—É—â–∞—Ç—å—Å—è –∫–∞–∫ –ª–∏—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è.
2.  **–ù–∏–∫–∞–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏:** –ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø–ª–∞–Ω–µ—Ç—ã, –∑–Ω–∞–∫–∏, –¥–æ–º–∞, –∞—Å–ø–µ–∫—Ç—ã –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç—å **—Ä–µ–∑—É–ª—å—Ç–∞—Ç** –∏—Ö –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –∂–∏–∑–Ω—å —á–µ–ª–æ–≤–µ–∫–∞, –∞ –Ω–µ —Å–∞–º –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å.
3.  **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –≥–ª—É–±–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫. –ò–∑–±–µ–≥–∞–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∏ "–≤–æ–¥—ã". –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–µ—Å—Ç–∏ —Å–º—ã—Å–ª.
4.  **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –í—Å–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã–º–∏ –≤ –∂–∏–∑–Ω–∏.
5.  **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è. –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è (\`##\`) –∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —ç–º–æ–¥–∑–∏. –í–Ω—É—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ (\`* \`) –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞ (—Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å):**

## ‚òÄÔ∏è 1. –°–ê–ú–û–û–¶–ï–ù–ö–ê
*   **–í–∞—à–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞:** [–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –°–æ–ª–Ω—Ü–∞ –∏ –ú–∞—Ä—Å–∞]
*   **–ö–∞–∫ –≤—ã –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ:** [–û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–ª–∏, —ç–Ω–µ—Ä–≥–∏–∏, –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞]
*   **–ò—Å—Ç–æ—á–Ω–∏–∫ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:** [–ß—Ç–æ –ø–∏—Ç–∞–µ—Ç –≤–∞—à—É —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É]

## üåô 2. –í–ê–®–ò –≠–ú–û–¶–ò–ò –ò –†–ê–°–°–õ–ê–ë–õ–ï–ù–ò–ï
*   **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∏—Ä:** [–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –õ—É–Ω—ã: –∫–∞–∫ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ, —á—Ç–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç –∫–æ–º—Ñ–æ—Ä—Ç]
*   **–°–ø–æ—Å–æ–±—ã —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è:** [–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏–ª—ã]
*   **–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è–º:** [–ê–Ω–∞–ª–∏–∑ –í–µ–Ω–µ—Ä—ã: —á—Ç–æ –≤—ã —Ü–µ–Ω–∏—Ç–µ, —á—Ç–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–∞–¥–æ—Å—Ç—å]

## ‚ú® 3. –¢–ê–õ–ê–ù–¢–´ –ò –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´ –õ–ò–ß–ù–û–°–¢–ò
*   **–í–∞—à–∏ —Å—É–ø–µ—Ä—Å–∏–ª—ã:** [–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ç–∞–ª–∞–Ω—Ç–æ–≤]
*   **–°–∫—Ä—ã—Ç—ã–µ —Ä–µ—Å—É—Ä—Å—ã:** [–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞–∑–≤–∏—Ç—å –≤ —Å–µ–±–µ]
*   **–ö–∞–∫ –≤—ã –ø—Ä–æ—è–≤–ª—è–µ—Ç–µ—Å—å:** [–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –∑–∞–º–µ—Ç–Ω—ã–µ –¥—Ä—É–≥–∏–º]

## üöß 4. –ú–ò–ù–£–°–´ –•–ê–†–ê–ö–¢–ï–†–ê –ò –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø
*   **–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:** [–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –º–∏–Ω—É—Å–æ–≤ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤]
*   **–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–∏:** [–ö–∞–∫–∏–µ "–≥—Ä–∞–±–ª–∏" –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –Ω–∞ –ø—É—Ç–∏]
*   **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏:** [3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –ø–æ—à–∞–≥–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]

## üé≠ 5. –•–ò–¢–†–û–°–¢–ò –ñ–ò–ó–ù–ò –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–û
*   **–í–∞—à –æ–±—Ä–∞–∑ –≤ –≥–ª–∞–∑–∞—Ö –¥—Ä—É–≥–∏—Ö:** [–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç–∞]
*   **–°–µ–∫—Ä–µ—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –º–∏—Ä–æ–º:** [–ö–∞–∫ –ª—É—á—à–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö]
*   **–í–ª–∏—è–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏–π:** [–ö–∞–∫ –≤—ã—Å—à–∏–µ –ø–ª–∞–Ω–µ—Ç—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ 40 –ª–µ—Ç]

## üöÄ 6. –§–û–†–ú–£–õ–ê –£–°–ü–ï–•–ê –ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
*   **–í–∞—à –ª–∏—á–Ω—ã–π –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É:** [–ö—Ä–∞—Ç–∫–∞—è, —ë–º–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞]
*   **–ß—Ç–æ –≤–∞—Å –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç:** [–ì–ª—É–±–∏–Ω–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã]
*   **–°—Ä–µ–¥–∞ –¥–ª—è –ø—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏—è:** [–í –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –≤—ã –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã]

## ‚ù§Ô∏è 7. –õ–ò–ß–ù–ê–Ø –ñ–ò–ó–ù–¨ –í –ö–ê–†–¢–ï
*   **–í–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö:** [–ß—Ç–æ –≤—ã –∏—â–µ—Ç–µ –≤ –ø–∞—Ä—Ç–Ω–µ—Ä–µ]
*   **–û–±—Ä–∞–∑ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:** [–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤]
*   **–ö–∞–∫ –≤—ã –≤—ã—Ä–∞–∂–∞–µ—Ç–µ —á—É–≤—Å—Ç–≤–∞:** [–°—Ç–∏–ª—å –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –ª—é–±–≤–∏ –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏]

## üíº 8. –ü–†–û–§–û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ò –°–ü–û–°–û–ë–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
*   **–ò–¥–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã:** [–û–¥–∏–Ω/–≤ –∫–æ–º–∞–Ω–¥–µ, –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ/—Å–≤–æ–±–æ–¥–Ω–æ –∏ —Ç.–¥.]
*   **–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** [–°–ø–∏—Å–æ–∫ –∏–∑ 5-7 –Ω–∏—à —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º, –ø–æ—á–µ–º—É –æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—Ç]
*   **–í–∞—à–∞ —Ä–æ–ª—å –≤ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–µ:** [–õ–∏–¥–µ—Ä, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –∏ —Ç.–¥.]

## üí∞ 9. –§–ò–ù–ê–ù–°–´ –í –ö–ê–†–¢–ï
*   **–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥–µ–Ω—å–≥–∞–º:** [–ö–∞–∫ –≤—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ, —Ç—Ä–∞—Ç–∏—Ç–µ, –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç–µ]
*   **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞:** [–û—Ç–∫—É–¥–∞ –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã]
*   **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ "—Ö–∏—Ç—Ä–æ—Å—Ç–∏":** [–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏]

–í–ê–ñ–ù–û!
–í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π. –î–∞–≤–∞–π —á—ë—Ç–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏. –ü–∏—à–∏ —ë–º–∫–æ, –Ω–æ –≥–ª—É–±–æ–∫–æ. –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞ ‚Äî —á–µ—Å—Ç–Ω–æ —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –º–∏–Ω–∏–º—É–º 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –º–∏–Ω—É—Å–æ–≤.`;
    
    const userPrompt = `–°–¥–µ–ª–∞–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:\n${chartDescription}`;

    const requestBody = {
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: systemPrompt,
        },
        {
          role: "user",
          content: userPrompt,
        },
      ],
    };

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify(requestBody),
    });

    const data = await response.json();

    if (!response.ok || !data.choices || data.choices.length === 0) {
      console.error('OpenAI API Error:', data);
      const errorMessage = data.error?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI.';
       return new Response(JSON.stringify({ error: errorMessage }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: response.status,
      });
    }

    const interpretation = data.choices[0].message.content;
    return new Response(JSON.stringify({ interpretation }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})